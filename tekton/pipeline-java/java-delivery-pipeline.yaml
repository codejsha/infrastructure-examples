apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: java-delivery-pipeline
spec:
  description: |
    tasks:
      - clone-cd-repo (git-clone)
      - kustomize-cd-repo (kustomize-cli)
      - git-commit (git-cli)
  workspaces:
    - name: shared-workspace
    - name: kube-config
    - name: input-asset
  params:
    - name: git-repo-url
      type: string
    - name: git-revision
      type: string
    - name: git-subdir
      type: string
    - name: kube-script
      type: string
    - name: kube-args
      type: string
    - name: git-user-name
      type: string
    - name: git-user-email
      type: string
    - name: git-script
      type: string
  tasks:
    - name: clone-cd-repo
      taskRef:
        name: git-clone
      params:
        - name: url
          value: $(params.git-repo-url)
        - name: revision
          value: $(params.git-revision)
        - name: subdirectory
          value: $(params.git-subdir)
      workspaces:
        - name: output
          workspace: shared-workspace
    - name: kustomize-cd-repo
      taskRef:
        name: kustomize-cli
      runAfter:
        - git-clone
      params:
        - name: script
          value: $(params.kube-script)
        - name: args
          value: $(params.kube-args)
      workspaces:
        - name: base-dir
          workspace: shared-workspace
        - name: kubeconfig-dir
          workspace: kube-config
    - name: git-commit
      taskRef:
        name: git-cli
      runAfter:
        - kubernetes-cd-repo
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: input
          workspace: input-asset
      params:
        - name: GIT_USER_NAME
          value: $(params.git-user-name)
        - name: GIT_USER_EMAIL
          value: $(params.git-user-email)
        - name: GIT_SCRIPT
          value: $(params.git-script)
