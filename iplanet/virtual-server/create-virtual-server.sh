#!/bin/bash
trap 'echo "${BASH_SOURCE[0]}: line ${LINENO}: status ${?}: user ${USER}: func ${FUNCNAME[0]}"' ERR
set -o errexit
set -o errtrace

IPLANET_HOME="/usr/local/iplanet"
IPLANET_HOST="test.example.com"
IPLANET_SSL_PORT="8989"
IPLANET_USER="admin"
IPLANET_PASSWORD="welcome1"

IPLANET_SERVER="${1:-"server1"}"
IPLANET_VSERVER="${2:-"vserver1"}"
IPLANET_VSERVER_DOCROOT="${IPLANET_HOME}/https-${IPLANET_SERVER}/docs"
HTTP_LISTENER_NAME="http-listener-1"

cat <<EOF > ${IPLANET_HOME}/pswd-file
wadm_password=${IPLANET_PASSWORD}
EOF

${IPLANET_HOME}/bin/wadm pull-config \
    --user="${IPLANET_USER}" \
    --password-file="${IPLANET_HOME}/pswd-file" \
    --host="${IPLANET_HOST}" \
    --port="${IPLANET_SSL_PORT}" \
    --ssl="true" \
    --rcfile="null" \
    --no-prompt \
    --config="${IPLANET_SERVER}" \
    --echo \
    "${IPLANET_HOST}"

${IPLANET_HOME}/bin/wadm create-virtual-server \
    --user="${IPLANET_USER}" \
    --password-file="${IPLANET_HOME}/pswd-file" \
    --host="${IPLANET_HOST}" \
    --port="${IPLANET_SSL_PORT}" \
    --ssl="true" \
    --rcfile="null" \
    --no-prompt \
    --config="${IPLANET_SERVER}" \
    --echo \
    --http-listener-name="${HTTP_LISTENER_NAME}" \
    --host-pattern="${IPLANET_SERVER}" \
    --document-root="${IPLANET_VSERVER_DOCROOT}" \
    "${IPLANET_VSERVER}"

${IPLANET_HOME}/bin/wadm deploy-config \
    --user="${IPLANET_USER}" \
    --password-file="${IPLANET_HOME}/pswd-file" \
    --host="${IPLANET_HOST}" \
    --port="${IPLANET_SSL_PORT}" \
    --ssl="true" \
    --rcfile="null" \
    --no-prompt \
    --echo \
    "${IPLANET_SERVER}"
